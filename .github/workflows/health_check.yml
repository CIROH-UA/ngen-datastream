name: NRDS Health Check

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Start date (YYYYMMDD)'
        required: false
        default: ''
      end_date:
        description: 'End date (YYYYMMDD)'
        required: false
        default: ''
      vpus:
        description: 'VPUs (comma-separated or "all")'
        required: false
        default: 'all'
      run_types:
        description: 'Run types (comma-separated or "all")'
        required: false
        default: 'all'
  schedule:
    - cron: '0 0 * * *'  # Every day at midnight UTC

permissions:
  contents: read
  id-token: write

jobs:
  health-check:
    runs-on: ubuntu-latest
    outputs:
      has_failures: ${{ steps.health_check.outputs.has_failures }}
      failure_count: ${{ steps.health_check.outputs.failure_count }}
      failures: ${{ steps.health_check.outputs.failures }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Verify health check script exists
        run: |
          if [ ! -f ./infra/aws/shell/check_datastream_outputs.sh ]; then
            echo "ERROR: Health check script not found at ./infra/aws/shell/check_datastream_outputs.sh"
            exit 1
          fi

      - name: Set Parameters
        id: params
        run: |
          # Default: check last 7 days for manual runs, yesterday for scheduled
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.start_date }}" ]; then
              START_DATE="${{ github.event.inputs.start_date }}"
            else
              START_DATE=$(date -d '7 days ago' +%Y%m%d)
            fi
            
            if [ -n "${{ github.event.inputs.end_date }}" ]; then
              END_DATE="${{ github.event.inputs.end_date }}"
            else
              END_DATE=$(date -d 'yesterday' +%Y%m%d)
            fi
            
            VPUS="${{ github.event.inputs.vpus }}"
            RUN_TYPES="${{ github.event.inputs.run_types }}"
          else
            # Scheduled run - check yesterday only
            START_DATE=$(date -d 'yesterday' +%Y%m%d)
            END_DATE=$(date -d 'yesterday' +%Y%m%d)
            VPUS="all"
            RUN_TYPES="all"
          fi
          
          echo "start_date=$START_DATE" >> $GITHUB_OUTPUT
          echo "end_date=$END_DATE" >> $GITHUB_OUTPUT
          echo "vpus=$VPUS" >> $GITHUB_OUTPUT
          echo "run_types=$RUN_TYPES" >> $GITHUB_OUTPUT
          
          echo "Health check parameters:"
          echo "  Date range: $START_DATE to $END_DATE"
          echo "  VPUs: $VPUS"
          echo "  Run types: $RUN_TYPES"

      - name: Run Health Check and Capture Failures
        id: health_check
        run: |
          set +e  # Don't exit on error
          chmod +x ./infra/aws/shell/check_datastream_outputs.sh
          ./infra/aws/shell/check_datastream_outputs.sh \
            --start ${{ steps.params.outputs.start_date }} \
            --end ${{ steps.params.outputs.end_date }} \
            --vpus ${{ steps.params.outputs.vpus }} \
            --run_types ${{ steps.params.outputs.run_types }} 2>&1 | tee health_output.txt
          
          SCRIPT_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
            echo "WARNING: Health check script exited with code $SCRIPT_EXIT_CODE"
            echo "Attempting to parse any available output..."
          fi
          
          # Parse failures into JSON array with validation
          failures=$(grep "missing" health_output.txt | awk '{print $1}' | while read url; do
            if [ -z "$url" ]; then
              continue
            fi
            
            date=$(echo "$url" | sed -n 's/.*ngen\.\([0-9]\{8\}\).*/\1/p')
            type=$(echo "$url" | sed -n 's/.*ngen\.[0-9]\{8\}\/\([^\/]*\).*/\1/p')
            cycle=$(echo "$url" | sed -n "s/.*\/$type\/\([0-9]\{2\}\).*/\1/p")
            vpu=$(echo "$url" | sed -n 's/.*VPU_\([^\/]*\).*/\1/p')
            
            # Skip if we couldn't parse required fields
            if [ -z "$date" ] || [ -z "$type" ] || [ -z "$cycle" ] || [ -z "$vpu" ]; then
              echo "WARNING: Failed to parse URL: $url" >&2
              continue
            fi
            
            if [[ "$type" == "medium_range" ]]; then
              ens=$(echo "$url" | sed -n 's/.*\/[0-9]\{2\}\/\([0-9]\)\/VPU.*/\1/p')
              echo "{\"date\":\"$date\",\"type\":\"$type\",\"cycle\":\"$cycle\",\"ensemble\":\"$ens\",\"vpu\":\"$vpu\",\"url\":\"$url\"}"
            else
              echo "{\"date\":\"$date\",\"type\":\"$type\",\"cycle\":\"$cycle\",\"vpu\":\"$vpu\",\"url\":\"$url\"}"
            fi
          done | jq -s '.')
          
          # Handle jq failure
          if [ $? -ne 0 ]; then
            echo "ERROR: Failed to parse failures with jq"
            failures="[]"
          fi
          
          # Set outputs
          echo "failures<<EOF" >> $GITHUB_OUTPUT
          echo "$failures" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          count=$(echo "$failures" | jq 'length')
          echo "has_failures=$([ $count -gt 0 ] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "failure_count=$count" >> $GITHUB_OUTPUT
          
          echo ""
          echo "Total failures found: $count"
          if [ $count -gt 0 ]; then
            echo "Failures:"
            echo "$failures" | jq '.'
          fi

  failure-summary:
    name: Failure Summary
    needs: [health-check]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate Summary
        run: |
          echo "# NRDS Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.health-check.outputs.has_failures }}" = "true" ]; then
            echo "## ⚠️ Failures Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Total Failures:** ${{ needs.health-check.outputs.failure_count }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Display failures in a table
            echo "| Date | Type | Cycle | VPU | Ensemble | URL |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|-------|-----|----------|-----|" >> $GITHUB_STEP_SUMMARY
            
            echo '${{ needs.health-check.outputs.failures }}' | jq -r '.[] | 
              if .ensemble then 
                "| \(.date) | \(.type) | \(.cycle) | \(.vpu) | \(.ensemble) | [Link](\(.url)) |"
              else 
                "| \(.date) | \(.type) | \(.cycle) | \(.vpu) | N/A | [Link](\(.url)) |"
              end' >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "_Rerun status unavailable: no rerun job was executed in this workflow run._" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ✅ No Failures Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All health checks passed successfully!" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY