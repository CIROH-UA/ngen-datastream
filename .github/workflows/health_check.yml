name: Test VPUs and Run Types (Standalone)

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  DATE: 20250905

jobs:
  test-all-vpus-and-run-types:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        vpu: ["01", "02", "03N", "03S", "03W", "04", "05", "06", "07", "08", "09", "10L", "10U", "11", "12", "13", "14", "15", "16", "17", "18"]
        run_type: ["short_range", "medium_range"] 
    permissions:
      id-token: write
      contents: read
     
    env:
      VPU: ${{ matrix.vpu }}
      RUN_TYPE: ${{ matrix.run_type }}
      DATE: 20250905
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Test-${{ matrix.run_type }}-VPU-${{ matrix.vpu }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          pip install --upgrade awscli boto3 pandas

      - name: Generate execution files using Python script
        run: |
          cd infra/aws
          python python/src/research_datastream/gen_vpu_execs.py \
            --arch arm \
            --inputs terraform/modules/schedules/config/execution_forecast_inputs.json \
            --ami_file terraform/modules/schedules/config/community_ami.txt \
            --exec_template_vpu terraform/modules/schedules/executions/templates/execution_datastream_VPU_template.json \
            --exec_template_fp terraform/modules/schedules/executions/templates/execution_datastream_fp_template.json \
            --out_dir test_executions

      - name: Determine execution file path
        id: exec_path
        run: |
          cd infra/aws
          
          # Find the execution file for this run_type and VPU
          # The file structure varies by run_type (e.g., short_range/00/, medium_range/00/1/, etc.)
          exec_file=$(find test_executions/${{ env.RUN_TYPE }} -name "execution_datastream_${{ env.VPU }}.json" | head -n 1)
          
          if [ -z "$exec_file" ]; then
            echo "::error::Could not find execution file for run_type=${{ env.RUN_TYPE }}, VPU=${{ env.VPU }}"
            exit 1
          fi
          
          echo "Found execution file: $exec_file"
          echo "exec_file=$exec_file" >> "$GITHUB_OUTPUT"

      - name: Modify execution for testing
        run: |
          cd infra/aws
          exec_file="${{ steps.exec_path.outputs.exec_file }}"
          
          # Update for testing with custom tags and S3 prefix
          jq --arg DATE "${{ env.DATE }}" \
             --arg VPU "${{ env.VPU }}" \
             --arg RUN_TYPE "${{ env.RUN_TYPE }}" '
            .instance_parameters.TagSpecifications = [{
              "ResourceType": "instance",
              "Tags": [
                {"Key": "Project", "Value": "test_\($RUN_TYPE)_vpu_\($VPU)"},
                {"Key": "AMI_Version", "Value": "test-version"},
                {"Key": "TestRunType", "Value": $RUN_TYPE}
              ]
            }] |
            .commands |= map(
                gsub("__S3_PREFIX__"; "tests/\($RUN_TYPE)/VPU_\($VPU)")
              | gsub("ngen.DAILY"; "ngen.\($DATE)")
              | gsub("-s DAILY"; "-s DAILY -e \($DATE)0000")
            )
          ' "$exec_file" > temp_execution.json
          
          mv temp_execution.json "$exec_file"
          echo "::group::Modified execution file for ${{ env.RUN_TYPE }} VPU ${{ env.VPU }}"
          cat "$exec_file"
          echo "::endgroup::"
      
      - name: Verify file was created successfully
        run: |
          cd infra/aws
          exec_file="${{ steps.exec_path.outputs.exec_file }}"
          echo "‚úÖ Successfully processed: ${{ env.RUN_TYPE }} / VPU ${{ env.VPU }}"
          echo "üìÅ File location: $exec_file"
          echo "üìä File size: $(wc -c < "$exec_file") bytes"