name: Terraform Drift Detection

on:
  schedule:
    # Run daily at 6 AM UTC (1 AM EST)
    - cron: '0 6 * * *'
  workflow_dispatch:

env:
  TF_VERSION: "1.10.0"
  AWS_REGION: us-east-1
  WORKING_DIR: infra/aws/terraform/services/nrds

permissions:
  contents: read

jobs:
  detect-drift:
    name: Drift Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::879381264451:role/github-actions-terraform-oidc
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init -backend-config="envs/prod.backend.hcl"

      - name: Terraform Plan (detect drift)
        id: plan
        run: |
          set +eo pipefail
          terraform plan -var-file="envs/prod.tfvars" -detailed-exitcode -input=false -lock-timeout=5m -no-color 2>&1 | tee plan_output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          set -eo pipefail

          # Exit codes: 0 = no changes, 1 = error, 2 = changes detected (drift)
          if [[ $EXIT_CODE -eq 2 ]]; then
            echo "drift_detected=true" >> "$GITHUB_OUTPUT"
            echo "::warning::Drift detected in nrds"

            SUMMARY=$(grep -E "Plan:|No changes" plan_output.txt | tail -1)
            echo "drift_summary=$SUMMARY" >> "$GITHUB_OUTPUT"
          elif [[ $EXIT_CODE -eq 0 ]]; then
            echo "drift_detected=false" >> "$GITHUB_OUTPUT"
            echo "No drift detected"
          else
            echo "drift_detected=error" >> "$GITHUB_OUTPUT"
            echo "::error::Terraform plan failed"
            exit 1
          fi

      - name: Save drift report
        if: always()
        run: |
          mkdir -p /tmp/drift-reports
          jq -n \
            --arg service "nrds" \
            --arg drift "${{ steps.plan.outputs.drift_detected }}" \
            --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            '{service: $service, drift_detected: $drift, timestamp: $ts, run_url: $url}' \
            > "/tmp/drift-reports/nrds.json"

      - name: Upload drift report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-nrds
          path: /tmp/drift-reports/
          retention-days: 30

  notify:
    name: Drift Summary
    needs: detect-drift
    if: always()
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Download drift report
        uses: actions/download-artifact@v4
        with:
          name: drift-report-nrds
          path: /tmp/drift-reports

      - name: Alert on drift
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const report = JSON.parse(fs.readFileSync('/tmp/drift-reports/nrds.json', 'utf8'));

            if (report.drift_detected === 'false') {
              const { data: openIssues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'terraform-drift',
              });
              for (const issue of openIssues) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  state_reason: 'completed',
                });
                console.log(`Closed resolved drift issue #${issue.number}`);
              }
              console.log('No drift detected.');
              return;
            }

            const isError = report.drift_detected === 'error';
            const lines = [
              isError ? '## Terraform Plan Error' : '## Terraform Drift Detected',
              '',
              isError
                ? `**Plan failed for nrds** — [View run](${report.run_url})`
                : `**Drift detected in nrds** — [View run](${report.run_url})`,
              '',
              '### Next Steps',
              '1. Review the plan output in the linked workflow run',
              '2. If the drift is intentional, run `terraform apply` to update state',
              '3. If the drift is unintended, investigate who/what modified the resource',
              '',
              `*Detected at ${new Date().toISOString()} by drift detection workflow*`,
            ];

            const body = lines.join('\n');
            const title = isError ? 'Terraform: plan error in nrds' : 'Terraform Drift: nrds';

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'terraform-drift',
              per_page: 1,
            });

            if (issues.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body,
              });
              console.log(`Updated existing drift issue #${issues[0].number}`);
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['terraform-drift'],
              });
              console.log('Created new drift issue');
            }
