name: Build, Test, and Push Datastream AMI
on:
  workflow_dispatch:
    inputs:
      ami_version:
        description: 'AMI version (e.g., 2.3)'
        required: true
        type: string
      ds_tag:
        description: 'Datastream Docker tag'
        required: true
        default: '1.0.1'
        type: string
      fp_tag:
        description: 'Forcing Processor Docker tag'
        required: true
        default: 'latest'
        type: string
      ngiab_tag:
        description: 'NGIAB Docker tag'
        required: true
        default: 'v0.0.0'
        type: string
  push:
    branches:
      - main
    paths:
      - 'ami_version.yml'

permissions:
  contents: read   

jobs:
  build-test-push-ami:
    runs-on: ubuntu-latest
    outputs:
      ds_tag: ${{ steps.changes.outputs.ds_tag }}
      fp_tag: ${{ steps.changes.outputs.fp_tag }}
      ngiab_tag: ${{ steps.changes.outputs.ngiab_tag }}
      ds_ami_version: ${{ steps.changes.outputs.ds_ami_version }}
      build_ds_ami: ${{ steps.changes.outputs.build_ds_ami }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Detect version changes
        id: changes
        shell: bash
        run: |
          set -euo pipefail

          # Check if triggered via workflow_dispatch with inputs
          if [ -n "${{ inputs.ami_version }}" ]; then
            echo "Using workflow_dispatch inputs"
            echo "ds_ami_version=${{ inputs.ami_version }}" >> "$GITHUB_OUTPUT"
            echo "ds_tag=${{ inputs.ds_tag }}" >> "$GITHUB_OUTPUT"
            echo "fp_tag=${{ inputs.fp_tag }}" >> "$GITHUB_OUTPUT"
            echo "ngiab_tag=${{ inputs.ngiab_tag }}" >> "$GITHUB_OUTPUT"
            echo "build_ds_ami=true" >> "$GITHUB_OUTPUT"
          else
            # Read from ami_version.yml (push trigger)
            CURRENT_DS_AMI=$(yq -r e '."datastream-ami-version"' ami_version.yml)
            DS_TAG=$(yq -r e '.DS_TAG' ami_version.yml)
            FP_TAG=$(yq -r e '.FP_TAG' ami_version.yml)
            NGIAB_TAG=$(yq -r e '.NGIAB_TAG' ami_version.yml)

            # Check previous commit for version change
            if git rev-parse HEAD~1 >/dev/null 2>&1 && git cat-file -e HEAD~1:ami_version.yml 2>/dev/null; then
              git show HEAD~1:ami_version.yml > previous_versions.yml
            else
              printf "datastream-ami-version: '0.0.0'\n" > previous_versions.yml
            fi

            PREVIOUS_DS_AMI=$(yq -r e '."datastream-ami-version"' previous_versions.yml)

            if [ "$CURRENT_DS_AMI" != "$PREVIOUS_DS_AMI" ]; then
              echo "datastream-ami-version changed: $PREVIOUS_DS_AMI -> $CURRENT_DS_AMI"
              echo "build_ds_ami=true" >> "$GITHUB_OUTPUT"
            else
              echo "build_ds_ami=false" >> "$GITHUB_OUTPUT"
            fi

            echo "ds_ami_version=$CURRENT_DS_AMI" >> "$GITHUB_OUTPUT"
            echo "ds_tag=$DS_TAG" >> "$GITHUB_OUTPUT"
            echo "fp_tag=$FP_TAG" >> "$GITHUB_OUTPUT"
            echo "ngiab_tag=$NGIAB_TAG" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure AWS
        run: |
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set region us-east-1        

      - name: Build AMI on AWS (N Virginia)
        if: steps.changes.outputs.build_ds_ami == 'true'
        run: |
          ami_version=""
          DS_TAG="${{ steps.changes.outputs.ds_tag }}"
          FP_TAG="${{ steps.changes.outputs.fp_tag }}"
          NGIAB_TAG="${{ steps.changes.outputs.ngiab_tag }}"
          
          if [ "${{ steps.changes.outputs.build_ds_ami }}" == "true" ]; then
            ami_version=datastream-"${{ steps.changes.outputs.ds_ami_version }}"
          fi
          
          # Pass environment variables to the script
          export AMI_NAME="$ami_version"
          export DS_TAG="$DS_TAG"
          export FP_TAG="$FP_TAG"
          export NGIAB_TAG="$NGIAB_TAG"
          chmod +x scripts/create_ami.sh
          ./scripts/create_ami.sh
          
  get-ami-info:
    needs: build-test-push-ami
    if: needs.build-test-push-ami.outputs.build_ds_ami == 'true'
    runs-on: ubuntu-latest
    outputs:
      ami_id: ${{ steps.get-ami.outputs.ami_id }}
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Get AMI ID
        id: get-ami
        run: |
          ami_name="datastream-${{ needs.build-test-push-ami.outputs.ds_ami_version }}"
          ami_id=$(aws ec2 describe-images \
            --owners self \
            --filters "Name=name,Values=$ami_name" \
            --query 'Images[0].ImageId' \
            --output text \
            --region us-east-1)
          echo "ami_id=$ami_id" >> "$GITHUB_OUTPUT"
