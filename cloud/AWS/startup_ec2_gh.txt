#!/bin/bash
arch=$(dpkg --print-architecture)
echo "Arch: "$arch
curl -L -O https://github.com/LynkerIntel/hfsubset/releases/download/hfsubset-release-12/hfsubset-linux_amd64.tar.gz
curl -L -O https://s3.amazonaws.com/mountpoint-s3-release/latest/x86_64/mount-s3.rpm
dnf update -y
dnf install ./mount-s3.rpm git pip pigz awscli -y
tar -xzvf hfsubset-linux_amd64.tar.gz
rm hfsubset-linux_amd64.tar.gz mount-s3.rpm
mv hfsubset /usr/bin/hfsubset
git clone https://github.com/CIROH-UA/ngen-datastream.git
aws configure set s3.max_concurrent_requests 256
dnf update
dnf -y install dnf-plugins-core
dnf install docker -y
systemctl start docker
usermod -aG docker ec2-user
newgrp docker
mkdir ./docker
aws s3 sync s3://ngen-datastream/docker/docker ./docker
cd docker 
docker build -t awiciroh/ngen-deps:latest -f Dockerfile.ngen-deps --no-cache . && docker build -t awiciroh/t-route:latest -f Dockerfile.t-route . --no-cache && docker build -t awiciroh/ngen -f Dockerfile.ngen . --no-cache && docker build -t awiciroh/ciroh-ngen-image:latest-local -f Dockerfile . --no-cache
echo "done!"

